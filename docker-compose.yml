version: "3.8"

# TinyMailServer - Simplified Mailu-based mail server for Portainer
# Based on https://github.com/Mailu/Mailu
# Images hosted at ghcr.io/mailu/

x-common-env: &common-env
  # Required
  SECRET_KEY: ${SECRET_KEY:-ChangeMeNow123456}
  DOMAIN: ${DOMAIN:-example.com}
  HOSTNAMES: ${HOSTNAMES:-mail.example.com}
  POSTMASTER: ${POSTMASTER:-admin}
  # TLS
  TLS_FLAVOR: ${TLS_FLAVOR:-letsencrypt}
  INBOUND_TLS_ENFORCE: ${INBOUND_TLS_ENFORCE:-false}
  # Features
  ADMIN: ${ADMIN:-true}
  WEBMAIL: ${WEBMAIL:-none}
  WEBDAV: ${WEBDAV:-none}
  ANTIVIRUS: ${ANTIVIRUS:-none}
  # Mail settings
  MESSAGE_SIZE_LIMIT: ${MESSAGE_SIZE_LIMIT:-50000000}
  MESSAGE_RATELIMIT: ${MESSAGE_RATELIMIT:-200/day}
  RELAYNETS: ${RELAYNETS:-}
  RELAYHOST: ${RELAYHOST:-}
  RELAYUSER: ${RELAYUSER:-}
  RELAYPASSWORD: ${RELAYPASSWORD:-}
  FETCHMAIL_DELAY: ${FETCHMAIL_DELAY:-600}
  RECIPIENT_DELIMITER: ${RECIPIENT_DELIMITER:-+}
  REJECT_UNLISTED_RECIPIENT: ${REJECT_UNLISTED_RECIPIENT:-yes}
  DMARC_RUA: ${DMARC_RUA:-admin}
  DMARC_RUF: ${DMARC_RUF:-admin}
  # Welcome
  WELCOME: ${WELCOME:-false}
  WELCOME_SUBJECT: ${WELCOME_SUBJECT:-Welcome to your new email account}
  WELCOME_BODY: ${WELCOME_BODY:-Welcome to your new email account!}
  # Web paths
  WEBROOT_REDIRECT: ${WEBROOT_REDIRECT:-/webmail}
  WEB_ADMIN: ${WEB_ADMIN:-/admin}
  WEB_WEBMAIL: ${WEB_WEBMAIL:-/webmail}
  SITENAME: ${SITENAME:-TinyMailServer}
  WEBSITE: ${WEBSITE:-https://github.com/vinzabe/tinymailserver}
  # Security
  AUTH_RATELIMIT: ${AUTH_RATELIMIT:-10/minute;1000/hour}
  DISABLE_STATISTICS: ${DISABLE_STATISTICS:-True}
  LOG_LEVEL: ${LOG_LEVEL:-WARNING}
  CREDENTIAL_ROUNDS: ${CREDENTIAL_ROUNDS:-12}
  REAL_IP_HEADER: ${REAL_IP_HEADER:-}
  REAL_IP_FROM: ${REAL_IP_FROM:-}
  # Network
  SUBNET: ${SUBNET:-192.168.203.0/24}

services:
  # Reverse proxy and SSL termination
  front:
    image: ghcr.io/mailu/nginx:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_front
    restart: unless-stopped
    environment:
      <<: *common-env
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:${HTTP_PORT:-80}:80"
      - "${BIND_ADDRESS:-0.0.0.0}:${HTTPS_PORT:-443}:443"
      - "${BIND_ADDRESS:-0.0.0.0}:${SMTP_PORT:-25}:25"
      - "${BIND_ADDRESS:-0.0.0.0}:465:465"
      - "${BIND_ADDRESS:-0.0.0.0}:587:587"
      - "${BIND_ADDRESS:-0.0.0.0}:110:110"
      - "${BIND_ADDRESS:-0.0.0.0}:995:995"
      - "${BIND_ADDRESS:-0.0.0.0}:143:143"
      - "${BIND_ADDRESS:-0.0.0.0}:993:993"
    volumes:
      - certs:/certs
      - overrides_nginx:/overrides:ro
    networks:
      default:
        aliases:
          - front
    depends_on:
      - redis
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Redis for caching and session storage
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      default:
        aliases:
          - redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # IMAP server (Dovecot)
  imap:
    image: ghcr.io/mailu/dovecot:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_imap
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - mail_data:/mail
      - overrides_dovecot:/overrides:ro
    networks:
      default:
        aliases:
          - imap
    depends_on:
      - front

  # SMTP server (Postfix)
  smtp:
    image: ghcr.io/mailu/postfix:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_smtp
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - mail_queue:/queue
      - overrides_postfix:/overrides:ro
    networks:
      default:
        aliases:
          - smtp
    depends_on:
      - front

  # Anti-spam (Rspamd)
  antispam:
    image: ghcr.io/mailu/rspamd:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_antispam
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - filter_data:/var/lib/rspamd
      - dkim_keys:/dkim:ro
      - overrides_rspamd:/etc/rspamd/override.d:ro
    networks:
      default:
        aliases:
          - antispam
    depends_on:
      - front

  # Admin interface
  admin:
    image: ghcr.io/mailu/admin:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_admin
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - admin_data:/data
      - dkim_keys:/dkim
    networks:
      default:
        aliases:
          - admin
    depends_on:
      - redis

  # Webmail (Roundcube or Snappymail)
  webmail:
    image: ghcr.io/mailu/${WEBMAIL:-snappymail}:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_webmail
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - webmail_data:/data
      - overrides_webmail:/overrides:ro
    networks:
      default:
        aliases:
          - webmail
    depends_on:
      - imap
    profiles:
      - webmail

  # Optional: ClamAV antivirus
  antivirus:
    image: ghcr.io/mailu/clamav:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_antivirus
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - filter_data:/data
    networks:
      default:
        aliases:
          - antivirus
    profiles:
      - antivirus

  # Optional: Fetchmail for external mail fetching
  fetchmail:
    image: ghcr.io/mailu/fetchmail:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_fetchmail
    restart: unless-stopped
    environment:
      <<: *common-env
    networks:
      default:
    profiles:
      - fetchmail

  # Optional: CalDAV/CardDAV (Radicale)
  webdav:
    image: ghcr.io/mailu/radicale:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_webdav
    restart: unless-stopped
    environment:
      <<: *common-env
    volumes:
      - dav_data:/data
    networks:
      default:
        aliases:
          - webdav
    profiles:
      - webdav

volumes:
  certs:
  redis_data:
  mail_data:
  mail_queue:
  filter_data:
  dkim_keys:
  admin_data:
  webmail_data:
  dav_data:
  overrides_nginx:
  overrides_dovecot:
  overrides_postfix:
  overrides_rspamd:
  overrides_webmail:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET:-192.168.203.0/24}
