version: "3.8"

# TinyMailServer - Simplified Mailu-based mail server for Portainer
# Based on https://github.com/Mailu/Mailu

services:
  # Reverse proxy and SSL termination
  front:
    image: mailu/nginx:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_front
    restart: unless-stopped
    env_file: stack.env
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:${HTTP_PORT:-80}:80"
      - "${BIND_ADDRESS:-0.0.0.0}:${HTTPS_PORT:-443}:443"
      - "${BIND_ADDRESS:-0.0.0.0}:25:25"      # SMTP
      - "${BIND_ADDRESS:-0.0.0.0}:465:465"    # SMTPS
      - "${BIND_ADDRESS:-0.0.0.0}:587:587"    # Submission
      - "${BIND_ADDRESS:-0.0.0.0}:110:110"    # POP3
      - "${BIND_ADDRESS:-0.0.0.0}:995:995"    # POP3S
      - "${BIND_ADDRESS:-0.0.0.0}:143:143"    # IMAP
      - "${BIND_ADDRESS:-0.0.0.0}:993:993"    # IMAPS
    volumes:
      - certs:/certs
      - overrides_nginx:/overrides:ro
    networks:
      - mail_network
    depends_on:
      - redis
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Redis for caching and session storage
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - mail_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # IMAP server (Dovecot)
  imap:
    image: mailu/dovecot:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_imap
    restart: unless-stopped
    env_file: stack.env
    volumes:
      - mail_data:/mail
      - overrides_dovecot:/overrides:ro
    networks:
      - mail_network
    depends_on:
      - front

  # SMTP server (Postfix)
  smtp:
    image: mailu/postfix:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_smtp
    restart: unless-stopped
    env_file: stack.env
    volumes:
      - mail_queue:/queue
      - overrides_postfix:/overrides:ro
    networks:
      - mail_network
    depends_on:
      - front

  # Anti-spam (Rspamd)
  antispam:
    image: mailu/rspamd:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_antispam
    restart: unless-stopped
    env_file: stack.env
    volumes:
      - filter_data:/var/lib/rspamd
      - dkim_keys:/dkim:ro
      - overrides_rspamd:/etc/rspamd/override.d:ro
    networks:
      - mail_network
    depends_on:
      - front

  # Admin interface
  admin:
    image: mailu/admin:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_admin
    restart: unless-stopped
    env_file: stack.env
    volumes:
      - admin_data:/data
      - dkim_keys:/dkim
    networks:
      - mail_network
    depends_on:
      - redis

  # Webmail (Roundcube or Snappymail)
  webmail:
    image: mailu/${WEBMAIL:-snappymail}:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_webmail
    restart: unless-stopped
    env_file: stack.env
    volumes:
      - webmail_data:/data
      - overrides_webmail:/overrides:ro
    networks:
      - mail_network
    depends_on:
      - imap
    profiles:
      - webmail

  # Optional: ClamAV antivirus
  antivirus:
    image: mailu/clamav:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_antivirus
    restart: unless-stopped
    env_file: stack.env
    volumes:
      - filter_data:/data
    networks:
      - mail_network
    profiles:
      - antivirus

  # Optional: Fetchmail for external mail fetching
  fetchmail:
    image: mailu/fetchmail:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_fetchmail
    restart: unless-stopped
    env_file: stack.env
    networks:
      - mail_network
    profiles:
      - fetchmail

  # Optional: CalDAV/CardDAV (Radicale)
  webdav:
    image: mailu/radicale:${VERSION:-2024.06}
    container_name: ${COMPOSE_PROJECT_NAME:-mail}_webdav
    restart: unless-stopped
    env_file: stack.env
    volumes:
      - dav_data:/data
    networks:
      - mail_network
    profiles:
      - webdav

volumes:
  certs:
    name: ${COMPOSE_PROJECT_NAME:-mail}_certs
  redis_data:
    name: ${COMPOSE_PROJECT_NAME:-mail}_redis
  mail_data:
    name: ${COMPOSE_PROJECT_NAME:-mail}_mail
  mail_queue:
    name: ${COMPOSE_PROJECT_NAME:-mail}_queue
  filter_data:
    name: ${COMPOSE_PROJECT_NAME:-mail}_filter
  dkim_keys:
    name: ${COMPOSE_PROJECT_NAME:-mail}_dkim
  admin_data:
    name: ${COMPOSE_PROJECT_NAME:-mail}_admin
  webmail_data:
    name: ${COMPOSE_PROJECT_NAME:-mail}_webmail
  dav_data:
    name: ${COMPOSE_PROJECT_NAME:-mail}_dav
  overrides_nginx:
    name: ${COMPOSE_PROJECT_NAME:-mail}_overrides_nginx
  overrides_dovecot:
    name: ${COMPOSE_PROJECT_NAME:-mail}_overrides_dovecot
  overrides_postfix:
    name: ${COMPOSE_PROJECT_NAME:-mail}_overrides_postfix
  overrides_rspamd:
    name: ${COMPOSE_PROJECT_NAME:-mail}_overrides_rspamd
  overrides_webmail:
    name: ${COMPOSE_PROJECT_NAME:-mail}_overrides_webmail

networks:
  mail_network:
    name: ${COMPOSE_PROJECT_NAME:-mail}_network
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET:-192.168.203.0/24}
